import asn1tools
import datetime
from functools import cache

@cache
def bytes_to_int(b: bytes) -> int:
    int_value = 0
    for i in range(len(b)):
        int_value = int_value * 256 + int(b[i])
    return int_value


@cache
def int_to_bytes(number: int) -> bytes:
    num_bytes = (number.bit_length() + 7) // 8
    little_endian_bytes = bytearray(num_bytes)
    for i in range(num_bytes):
        little_endian_bytes[i] = (number >> (8 * i)) & 0xFF
    return bytes(little_endian_bytes)[::-1]


MESSAGE_TYPES = {
    0x61: 'Ticket',
    0x62: 'Authenticator',
    0x63: 'EncTicketPart',
    0x6A: 'AS-REQ',
    0x6B: 'AS-REP',
    0x6C: 'TGS-REQ',
    0x6D: 'TGS-REP',
    0x6E: 'AP-REQ',
    0x6F: 'AP-REP',
    0x74: 'KRB-SAFE',
    0x75: 'KRB-PRIV',
    0x76: 'KRB-CRED',
    0x79: 'EncASRepPart',
    0x7A: 'EncTGSRepPart',
    0x7B: 'EncPRepPart',
    0x7C: 'EncKrbPrivPart',
    0x7D: 'EncKrbCredPart',
    0x7E: 'KRB-ERROR',
}



as_req_data = b'\x6a\x81\xd0\x30\x81\xcd\xa1\x03\x02\x01\x05\xa2\x03\x02\x01\x0a\xa3\x15\x30\x13\x30\x11\xa1\x04\x02\x02\x00\x80\xa2\x09\x04\x07\x30\x05\xa0\x03\x01\x01\xff\xa4\x81\xa9\x30\x81\xa6\xa0\x07\x03\x05\x00\x40\x81\x00\x10\xa1\x14\x30\x12\xa0\x03\x02\x01\x01\xa1\x0b\x30\x09\x1b\x07\x63\x68\x61\x72\x6c\x69\x65\xa2\x06\x1b\x04\x43\x53\x45\x43\xa3\x19\x30\x17\xa0\x03\x02\x01\x02\xa1\x10\x30\x0e\x1b\x06\x6b\x72\x62\x74\x67\x74\x1b\x04\x43\x53\x45\x43\xa5\x11\x18\x0f\x32\x30\x33\x37\x30\x39\x31\x33\x30\x32\x34\x38\x30\x35\x5a\xa6\x11\x18\x0f\x32\x30\x33\x37\x30\x39\x31\x33\x30\x32\x34\x38\x30\x35\x5a\xa7\x06\x02\x04\x1a\x14\x2c\x03\xa8\x15\x30\x13\x02\x01\x12\x02\x01\x11\x02\x01\x17\x02\x01\x18\x02\x02\xff\x79\x02\x01\x03\xa9\x1d\x30\x1b\x30\x19\xa0\x03\x02\x01\x14\xa1\x12\x04\x10\x44\x45\x53\x4b\x54\x4f\x50\x2d\x56\x49\x34\x33\x39\x36\x42\x20'
as_req_template = {
    'pvno': 5,
    'msg-type': 10,
    'padata':
    [
        {
            'padata-type': 128,
            'padata-value': b'0\x05\xa0\x03\x01\x01\xff'
        }
    ],
    'req-body':
    {
        'kdc-options': (b'@\x81\x00\x10', 32),
        'cname':
        {
            'name-type': 1,
            'name-string': ['charlie']
        },
        'realm': 'CSEC',
        'sname':
        {
            'name-type': 2,
            'name-string': ['krbtgt', 'CSEC']
        },
        'till': datetime.datetime(2037, 9, 13, 2, 48, 5),
        'rtime': datetime.datetime(2037, 9, 13, 2, 48, 5),
        'nonce': 437529603,
        'etype': [23],
        'addresses':
        [
            {
                'addr-type': 20,
                'address': b'DESKTOP-VI4396B '
            }
        ]
    }
}
tgs_req_template = {}
krb5 = asn1tools.compile_files('krb5.asn', 'der')
print(krb5.decode(MESSAGE_TYPES[as_req_data[0]], as_req_data))
exit()

def main():
    ...


if __name__ == '__main__':
    main()


client_GUID = b'\xd6\x19\x6b\xc6\xcf\x94\x11\xee\x91\x91\x00\x50\x56\xb0\xf2\xfa'
client_GUID = b'\xd6\x19\x6b\xdb\xcf\x94\x11\xee\x91\x91\x00\x50\x56\xb0\xf2\xfa'
smb_proto_neg_1 = b'\x00\x00\x00\x9b\xff\x53\x4d\x42\x72\x00\x00\x00\x00\x18\x53\xc8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xfe\x00\x00\x00\x00\x00\x78\x00\x02\x50\x43\x20\x4e\x45\x54\x57\x4f\x52\x4b\x20\x50\x52\x4f\x47\x52\x41\x4d\x20\x31\x2e\x30\x00\x02\x4c\x41\x4e\x4d\x41\x4e\x31\x2e\x30\x00\x02\x57\x69\x6e\x64\x6f\x77\x73\x20\x66\x6f\x72\x20\x57\x6f\x72\x6b\x67\x72\x6f\x75\x70\x73\x20\x33\x2e\x31\x61\x00\x02\x4c\x4d\x31\x2e\x32\x58\x30\x30\x32\x00\x02\x4c\x41\x4e\x4d\x41\x4e\x32\x2e\x31\x00\x02\x4e\x54\x20\x4c\x4d\x20\x30\x2e\x31\x32\x00\x02\x53\x4d\x42\x20\x32\x2e\x30\x30\x32\x00\x02\x53\x4d\x42\x20\x32\x2e\x3f\x3f\x3f\x00'
smb_proto_neg_2 = bytes(f'\x00\x00\x00\xe4\xfe\x53\x4d\x42\x40\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x00\x00\x00\x00\x00\x00\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x24\x00\x05\x00\x01\x00\x00\x00\x7f\x00\x00\x00\xc6\x6b\x19{client_GUID}\x70\x00\x00\x00\x04\x00\x00\x00\x02\x02\x10\x02\x00\x03\x02\x03\x11\x03\x00\x00\x01\x00\x26\x00\x00\x00\x00\x00\x01\x00\x20\x00\x01\x00\x3a\x73\x72\x67\xfe\xc1\xe2\xa2\x7b\xcd\x31\xf0\xf8\x13\xfd\x94\x19\xc1\x63\x96\x88\x9b\x53\xf6\x5c\x60\x7b\xbc\xd4\xf5\x80\x74\x00\x00\x02\x00\x06\x00\x00\x00\x00\x00\x02\x00\x02\x00\x01\x00\x00\x00\x03\x00\x10\x00\x00\x00\x00\x00\x04\x00\x00\x00\x01\x00\x00\x00\x04\x00\x02\x00\x03\x00\x01\x00\x05\x00\x14\x00\x00\x00\x00\x00\x46\x00\x49\x00\x4c\x00\x45\x00\x53\x00\x45\x00\x52\x00\x56\x00\x45\x00\x52\x00')

username = 'charlie'
password = 'NewStudent123'
password_hash = ''
domain = 'CSEC'
krb_addr = ('192.168.1.103', 88)
ss_addr = ('192.168.1.104', 445)
